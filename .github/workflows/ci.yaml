name: CI

on:
  merge_group:
  pull_request:
    paths-ignore:
      - 'DCO'
      - 'LICENSE'
      - 'README.md'
      - 'HOW_TO_RELEASE.md'
      - 'RELEASE_NOTES.md'
    branches:
      - "main"
      - "v**"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  static-security-analysis:
    runs-on: ubuntu-22.04
    env:
      GO111MODULE: on
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
      #- name: Run Gosec Security Scanner
      #  uses: securego/gosec@v2.21.2
      #   with:
      #     args: -exclude-dir e2etest -severity medium ./...

      - name: Golang Vulncheck
        uses: golang/govulncheck-action@v1
        with:
          go-version-file: go.mod

  check-generated:
    runs-on: ubuntu-22.04
    if: github.actor != 'dependabot[bot]'
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-go@v5
        with:
          go-version-file: "go.mod"
          cache: true
      - name: Check Generated
        run: |
          make bumplicense
          make manifests
          make generate
          make generate-all-in-one
          # make api-docs
          make checkuncommitted

      - name: Helm doc generate
        uses: docker://jnorwood/helm-docs:v1.10.0

      - name: Check if docs are different
        run: make checkuncommitted

  commitlint:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: wagoid/commitlint-github-action@v5

  build-kind-node-image:
    runs-on: ubuntu-22.04
    outputs:
      kind-node-version: ${{ steps.kind_version.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract KIND_NODE_VERSION from Makefile
        id: kind_version
        run: |
          KIND_NODE_VERSION=$(make -f Makefile --eval='print-kind-version: ; @echo $(KIND_NODE_VERSION)' print-kind-version)
          echo "version=$KIND_NODE_VERSION" >> $GITHUB_OUTPUT
          echo "KIND_NODE_VERSION=$KIND_NODE_VERSION"

      - name: Setup docker buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and export kind-node-openperouter image
        uses: docker/build-push-action@v5
        with:
          context: hack/kind-node-image
          file: hack/kind-node-image/Dockerfile
          build-args: |
            KIND_NODE_VERSION=${{ steps.kind_version.outputs.version }}
          tags: quay.io/openperouter/kind-node-openperouter:${{ steps.kind_version.outputs.version }}
          outputs: type=docker,dest=/tmp/kind-node-openperouter.tar
          cache-from: type=gha,scope=kind-node-openperouter
          cache-to: type=gha,mode=max,scope=kind-node-openperouter

      - name: Upload kind-node-openperouter artifact
        uses: actions/upload-artifact@v4
        with:
          retention-days: 1
          name: image-tar-kind-node-openperouter
          path: /tmp/kind-node-openperouter.tar

  unit-tests:
    runs-on: ubuntu-22.04
    needs: build-kind-node-image
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: "go.mod"
          cache: true

      - name: Install kernel modules
        run: |
          sudo apt-get update
          sudo apt-get install linux-modules-extra-$(uname -r)

      - name: Free Disk Space
        working-directory: ${{ github.workspace }}
        run: |
          echo "Disk space before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo apt-get clean
          echo "Disk space after cleanup:"
          df -h

      - name: Download kind-node-openperouter image
        uses: actions/download-artifact@v4
        with:
          name: image-tar-kind-node-openperouter
          path: /tmp

      - name: Load kind-node-openperouter image
        run: |
          docker load -i /tmp/kind-node-openperouter.tar

      - name: Unit Tests
        run: |
          make test

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v9.2.0
        with:
          version: v2.9.0

      - name: Verify bundle manifests
        run: |
          make bundle
          git diff --exit-code -I'^    createdAt: ' operator/bundle

  build-test-images:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: true
    steps:
      - name: Code checkout
        uses: actions/checkout@v4
      - name: Setup docker buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and export the image
        uses: docker/build-push-action@v5
        with:
          context: .
          tags: quay.io/openperouter/router:main,localhost:5000/router:main
          file: Dockerfile
          outputs: type=docker,dest=/tmp/openperouter.tar
          cache-from: type=gha
          cache-to: type=gha,mode=max
      - name: Upload openperouter artifact
        uses: actions/upload-artifact@v4
        with:
          retention-days: 1
          name: image-tar-openperouter
          path: /tmp/openperouter.tar

  build-grout-test-images:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: true
    steps:
      - name: Code checkout
        uses: actions/checkout@v4
      - name: Setup docker buildx
        uses: docker/setup-buildx-action@v3

      - name: Build grout sidecar image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.grout
          tags: quay.io/openperouter/grout:main
          outputs: type=docker,dest=/tmp/grout.tar
          cache-from: type=gha,scope=grout
          cache-to: type=gha,mode=max,scope=grout

      - name: Build FRR+dplane_grout base image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile.frr-grout
          tags: quay.io/openperouter/frr-grout:main
          outputs: type=docker,dest=/tmp/frr-grout.tar
          cache-from: type=gha,scope=frr-grout
          cache-to: type=gha,mode=max,scope=frr-grout

      - name: Load frr-grout image for router build
        run: |
          docker load -i /tmp/frr-grout.tar

      - name: Build router image with grout support
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          build-args: FRR_IMAGE=quay.io/openperouter/frr-grout:main
          tags: quay.io/openperouter/router:main-grout
          outputs: type=docker,dest=/tmp/openperouter-grout.tar

      - name: Upload grout artifact
        uses: actions/upload-artifact@v4
        with:
          retention-days: 1
          name: image-tar-grout
          path: /tmp/grout.tar

      - name: Upload openperouter-grout artifact
        uses: actions/upload-artifact@v4
        with:
          retention-days: 1
          name: image-tar-openperouter-grout
          path: /tmp/openperouter-grout.tar

  e2etests:
    runs-on: ubuntu-22.04
    env:
      NODE_IMAGE: quay.io/openperouter/kind-node-openperouter:${{ needs.build-kind-node-image.outputs.kind-node-version }}
    needs:
      - build-kind-node-image
      - unit-tests
      - build-test-images
    strategy:
      fail-fast: false
      matrix:
        deployment: [manifests, helm, operator, systemdmode, hostmode-boot]
    steps:
      - name: Free Disk Space
        working-directory: ${{ github.workspace }}
        run: |
          echo "Disk space before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo apt-get clean
          echo "Disk space after cleanup:"
          df -h

      - name: Checkout
        uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: "go.mod"
          cache: true

      - name: Install kernel modules
        run: |
          sudo apt-get update
          sudo apt-get install linux-modules-extra-$(uname -r)

      - name: Disable containerd image store
        run: |
          sudo bash -c 'cat > /etc/docker/daemon.json << EOF
          {
            "features": {
              "containerd-snapshotter": false
            }
          }
          EOF'
          sudo systemctl restart docker
          docker info -f '{{ .DriverStatus }}'

      - name: Download kind-node-openperouter image
        uses: actions/download-artifact@v4
        with:
          name: image-tar-kind-node-openperouter
          path: /tmp

      - name: Load kind-node-openperouter image
        run: |
          docker load -i /tmp/kind-node-openperouter.tar

      - name: Download openperouter image
        uses: actions/download-artifact@v4
        with:
          path: image

      - name: Load image
        working-directory: image
        run: |
          docker load -i image-tar-openperouter/openperouter.tar

      - name: Deploy the cluster
        run: |
          MAKE_RULE="deploy"
          IMG_REPO="quay.io/openperouter"
          if [ ${{ matrix.deployment }} = "helm" ]; then MAKE_RULE="deploy-helm"; fi
          if [ ${{ matrix.deployment }} = "systemdmode" ]; then MAKE_RULE="deploy-hostmode"; fi
          if [ ${{ matrix.deployment }} = "hostmode-boot" ]; then MAKE_RULE="deploy-hostmode-boot"; fi
          if [ ${{ matrix.deployment }} = "operator" ]; then MAKE_RULE="deploy-operator-with-olm"; IMG_REPO="localhost:5000"; export USE_HTTP=--use-http; export TLS_VERIFY=false; export KUBECONFIG=bin/kubeconfig; fi
          IMG_REPO=$IMG_REPO make $MAKE_RULE
          if [ ${{ matrix.deployment }} = "operator" ]; then IMG_REPO="quay.io/openperouter" make load-on-kind; kubectl apply -f operator/config/samples/openperouter.yaml; sleep 5; kubectl -n openperouter-system wait --for=condition=Ready pods -l "component in (controller,router,nodemarker)" --timeout 300s; fi

      - name: Run e2e tests
        run: |
          if [ ${{ matrix.deployment }} = "systemdmode" ]; then
            export TEST_ARGS="--systemdmode"
            export GINKGO_ARGS="--skip='Router Host configuration' --skip='North/south traffic after FRR container restart'"
            make e2etests
          elif [ ${{ matrix.deployment }} = "hostmode-boot" ]; then
            make e2etests-hostmode-boot
          else
            make e2etests
          fi

      - name: Export kind logs
        if: ${{ failure() }}
        run:
          make kind-export-logs

      - name: Collect Logs
        if: ${{ failure() }}
        uses: ./.github/workflows/composite/collectlogs
        with:
          artifact-name: kind-logs-${{ matrix.deployment }}

  e2etests-grout:
    runs-on: ubuntu-22.04
    env:
      NODE_IMAGE: quay.io/openperouter/kind-node-openperouter:${{ needs.build-kind-node-image.outputs.kind-node-version }}
    needs:
      - build-kind-node-image
      - unit-tests
      - build-grout-test-images
    steps:
      - name: Free Disk Space
        working-directory: ${{ github.workspace }}
        run: |
          echo "Disk space before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo apt-get clean
          echo "Disk space after cleanup:"
          df -h

      - name: Checkout
        uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: "go.mod"
          cache: true

      - name: Install kernel modules
        run: |
          sudo apt-get update
          sudo apt-get install linux-modules-extra-$(uname -r)

      - name: Download kind-node-openperouter image
        uses: actions/download-artifact@v4
        with:
          name: image-tar-kind-node-openperouter
          path: /tmp

      - name: Load kind-node-openperouter image
        run: |
          docker load -i /tmp/kind-node-openperouter.tar

      - name: Download grout-enabled router image
        uses: actions/download-artifact@v4
        with:
          name: image-tar-openperouter-grout
          path: /tmp

      - name: Download grout sidecar image
        uses: actions/download-artifact@v4
        with:
          name: image-tar-grout
          path: /tmp

      - name: Load images
        run: |
          docker load -i /tmp/openperouter-grout.tar
          docker tag quay.io/openperouter/router:main-grout quay.io/openperouter/router:main
          docker load -i /tmp/grout.tar

      - name: Deploy the cluster with grout
        run: |
          make deploy-helm-grout

      - name: Run L3 Passthrough e2e tests
        run: |
          make e2etests-grout

      - name: Export kind logs
        if: ${{ failure() }}
        run:
          make kind-export-logs

      - name: Collect Logs
        if: ${{ failure() }}
        uses: ./.github/workflows/composite/collectlogs
        with:
          artifact-name: kind-logs-grout
